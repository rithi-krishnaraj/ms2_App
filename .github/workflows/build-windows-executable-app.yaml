name: Build Executable for Windows on Release

on:
  release:
    types: ["created"]

permissions:
  contents: write

jobs:
  build-executable:
    runs-on: windows-latest

    env:
      PYTHON_VERSION: 3.9.0
      APP_NAME: MS2-Scan-Analyzer

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller ms2_main.py --onefile --noconsole --name ms2_App
          echo "Executable built at dist/ms2_App.exe"

      - name: Setup Python Embeddable Version
        run: |
          mkdir python-${{ env.PYTHON_VERSION }}
          curl -O https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip
          unzip python-${{ env.PYTHON_VERSION }}-embed-amd64.zip -d python-${{ env.PYTHON_VERSION }}
          rm python-${{ env.PYTHON_VERSION }}-embed-amd64.zip

      - name: Install pip
        run: |
          curl -O https://bootstrap.pypa.io/get-pip.py
          ./python-${{ env.PYTHON_VERSION }}/python get-pip.py --no-warn-script-location
          rm get-pip.py

      - name: Enable site-packages
        run: |
          $pthFile = Get-ChildItem -Path "python-${{ env.PYTHON_VERSION }}" -Filter "*._pth" | Select-Object -First 1
          (Get-Content $pthFile.FullName) -replace '#import site', 'import site' | Set-Content $pthFile.FullName

      - name: Install Required Packages
        run: |
          .\python-${{ env.PYTHON_VERSION }}\python -m pip install Cython --no-warn-script-location
          .\python-${{ env.PYTHON_VERSION }}\python -m pip install numpy --no-warn-script-location
          .\python-${{ env.PYTHON_VERSION }}\python -m pip install -r requirements-windows.txt --no-warn-script-location

      - name: Create Streamlit Config Directory
        run: |
          mkdir .streamlit

      - name: Create Streamlit Config for Network Access
        shell: bash
        run: |
          cat <<EOF > .streamlit/config.toml
          [server]
          # Use localhost for local access
          address = "localhost"
          
          # Allow browser to open automatically
          headless = false
          
          # Enable CORS for all origins
          enableCORS = false
          enableXsrfProtection = false
          
          [browser]
          # Allow browser to open
          gatherUsageStats = false
          serverAddress = "localhost"
          EOF

      - name: Create Advanced Launcher BAT File
        shell: bash
        run: |
          cat <<'EOF' > ${{ env.APP_NAME }}.bat
          @echo off
          setlocal enabledelayedexpansion
          
          taskkill /F /IM python.exe /FI "WINDOWTITLE eq *streamlit*" 2>nul >nul
          timeout /t 2 /nobreak >nul
          
          set PORT=8501
          set MAX_PORT=8600
          
          :FIND_PORT
          netstat -an | findstr ":!PORT! " | findstr "LISTENING" >nul
          if !errorlevel! equ 0 (
              set /a PORT+=1
              if !PORT! leq %MAX_PORT% goto FIND_PORT
              echo ERROR: No available ports found
              pause
              exit /b 1
          )
          
          start /B .\python-${{ env.PYTHON_VERSION }}\python -m streamlit run ms2_main.py --server.port !PORT! --server.address localhost --browser.serverAddress localhost --browser.gatherUsageStats false
          
          timeout /t 3 /nobreak >nul
          start "" "http://localhost:!PORT!"
          
          pause
          EOF

      - name: Convert PNG icon to ICO
        run: |
          magick ms2_scanicon.png -resize 256x256 ms2_scanicon.ico

      - name: Create Executable Folder
        run: |
          mkdir dist_folder
          mv python-${{ env.PYTHON_VERSION }} dist_folder/
          mv .streamlit dist_folder/
          cp ms2_main.py dist_folder/
          cp requirements-windows.txt dist_folder/
          cp README.md dist_folder/
          cp LICENSE.rtf dist_folder/
          cp "${{ env.APP_NAME }}.bat" dist_folder/
          cp ms2_scanicon.ico dist_folder/

      - name: Create Firewall Setup Script
        shell: bash
        run: |
          cat <<'EOF' > dist_folder/configure_firewall.bat
          @echo off
          netsh advfirewall firewall add rule name="${{ env.APP_NAME }}" dir=in action=allow protocol=TCP localport=8501-8600 enable=yes
          if %errorlevel% equ 0 (
              echo Firewall configured successfully
          ) else (
              echo Failed - run as Administrator
          )
          pause
          EOF
          
          cat <<'EOF' > dist_folder/kill_streamlit.bat
          @echo off
          taskkill /F /IM python.exe 2>nul
          echo Streamlit processes stopped
          pause
          EOF

      - name: Generate Readme
        shell: bash
        run: |
          cat <<EOF > dist_folder/README.md
          # Welcome to the ${{ env.APP_NAME }} application!
          
          ## To run the app:
          1. Open the installation folder
          2. Double-click **${{ env.APP_NAME }}.bat**
          3. Your default browser will automatically open to http://localhost:[PORT]
          4. The console window will show the exact URL and port being used
          
          ## Network Access:
          - **Local access**: http://localhost:[PORT] (automatically opens in browser)
          - **Network access**: http://[YOUR-COMPUTER-NAME]:[PORT]
          - Port range: 8501-8600 (automatically finds available port)
          
          ## If You See an Old Version:
          If the app shows an older version or wrong content:
          1. Close all browser tabs with the app
          2. Double-click **kill_streamlit.bat** to stop all instances
          3. Clear your browser cache (Ctrl+Shift+Delete)
          4. Start the app again with **${{ env.APP_NAME }}.bat**
          
          ## If Browser Doesn't Open Automatically:
          1. Check the console window for the URL (e.g., http://localhost:8501)
          2. Manually copy and paste the URL into your browser
          3. Make sure your default browser is set correctly in Windows
          
          ## Firewall Configuration (For Network Access):
          If you can't access the app from other devices on your network:
          1. Right-click **configure_firewall.bat**
          2. Select "Run as administrator"
          3. This will allow incoming connections on ports 8501-8600
          
          ## Troubleshooting:
          - **Port conflicts**: The app automatically finds free ports (8501-8600)
          - **Browser not opening**: Check console for URL and open manually
          - **Old version showing**: Run kill_streamlit.bat and clear browser cache
          - **Can't access from network**: Run configure_firewall.bat as Administrator
          - **Multiple instances**: Each instance will use a different port
          
          ## Utility Scripts:
          - **${{ env.APP_NAME }}.bat** - Start the application
          - **kill_streamlit.bat** - Stop all Streamlit processes
          - **configure_firewall.bat** - Configure Windows Firewall (requires Admin)
          
          Thank you!
          EOF

      - name: Install WiX Toolset
        run: |
          curl -LO https://github.com/wixtoolset/wix3/releases/download/wix3111rtm/wix311-binaries.zip
          unzip wix311-binaries.zip -d wix
          rm wix311-binaries.zip

      - name: Heat - Generate .wxs from folder
        run: |
          ./wix/heat.exe dir dist_folder -gg -sfrag -sreg -srd -template component -cg StreamlitExeFiles -dr AppSubFolder -out streamlit_exe_files.wxs

      - name: Create VBScript Success Message
        shell: bash
        run: |
          cat <<EOF > ShowSuccessMessage.vbs
          MsgBox "The ${{ env.APP_NAME }} application was installed successfully." & vbCrLf & vbCrLf & "For network access, run configure_firewall.bat as Administrator.", vbInformation, "Installation Complete"
          EOF

      - name: Prepare SourceDir
        run: |
          mkdir SourceDir
          mv dist_folder/* SourceDir
          cp ShowSuccessMessage.vbs SourceDir
          echo "Sample License Text" > SourceDir/app_license.rtf

      - name: Generate streamlit_exe.wxs
        shell: bash
        run: |
          cat <<EOF > streamlit_exe.wxs
          <?xml version="1.0"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" Name="${{ env.APP_NAME }}" Language="1033" Version="1.0.0" Manufacturer="Your Org" UpgradeCode="b3e2c7a1-5e2a-4f6c-9e2d-1a2b3c4d5e6f">
              <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="x64"/>
              <Media Id="1" Cabinet="media.cab" EmbedCab="yes"/>
              <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER"/>
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFilesFolder">
                  <Directory Id="INSTALLFOLDER" Name="${{ env.APP_NAME }}">
                    <Directory Id="AppSubFolder" Name="${{ env.APP_NAME }}"/>
                  </Directory>
                </Directory>
                <Directory Id="DesktopFolder"/>
              </Directory>
              <Feature Id="MainFeature" Title="Main App" Level="1">
                <ComponentGroupRef Id="StreamlitExeFiles"/>
                <ComponentRef Id="DesktopShortcutComponent"/>
              </Feature>
              <Component Id="DesktopShortcutComponent" Guid="B1110000-0000-0000-0000-000000000001" Directory="DesktopFolder">
                <Shortcut Id="AppShortcut" Name="${{ env.APP_NAME }}" Description="Launch" Target="[AppSubFolder]${{ env.APP_NAME }}.bat" WorkingDirectory="AppSubFolder" Icon="AppIcon"/>
                <RegistryValue Root="HKCU" Key="Software\\${{ env.APP_NAME }}" Name="Installed" Type="integer" Value="1" KeyPath="yes"/>
              </Component>
              <Icon Id="AppIcon" SourceFile="SourceDir/ms2_scanicon.ico" />
              <Binary Id="VBSMessage" SourceFile="SourceDir/ShowSuccessMessage.vbs"/>
              <CustomAction Id="ShowSuccess" BinaryKey="VBSMessage" VBScriptCall="" Execute="immediate" Return="check"/>
              <InstallExecuteSequence>
                <Custom Action="ShowSuccess" After="InstallFinalize">NOT Installed</Custom>
              </InstallExecuteSequence>
              <UI>
                <UIRef Id="WixUI_InstallDir"/>
                <UIRef Id="WixUI_ErrorProgressText"/>
              </UI>
              <WixVariable Id="WixUILicenseRtf" Value="SourceDir/app_license.rtf"/>
            </Product>
          </Wix>
          EOF

      - name: Candle WiX Installer
        run: |
          ./wix/candle.exe streamlit_exe.wxs -out streamlit_exe.wixobj
          ./wix/candle.exe streamlit_exe_files.wxs -out streamlit_exe_files.wixobj

      - name: Light WiX Installer
        run: |
          ./wix/light.exe streamlit_exe.wixobj streamlit_exe_files.wixobj -ext WixUIExtension -o "${{ env.APP_NAME }}.msi" -cultures:en-us

      - name: Upload artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/ms2_App.exe
            ${{ env.APP_NAME }}.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}