name: Build Executable for Windows on Release

on:
  release:
    types: ["created"]

permissions:
  contents: write

jobs:
  build-executable:
    runs-on: windows-latest

    env:
      PYTHON_VERSION: 3.9.0
      APP_NAME: MS2-Scan-Analyzer
      APP_VERSION: '1.0.0' # Default, will be overwritten by release tag

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Release Version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}
            echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          else
            echo "Not a tag, using default version 1.0.0"
          fi

      - name: Set up Python for Build Environment
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller ms2_main.py --onefile --noconsole --name ms2_App
          echo "Executable built at dist/ms2_App.exe"

      - name: Download & Setup Python Embeddable Version
        run: |
          mkdir python-${{ env.PYTHON_VERSION }}
          curl -O https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip
          tar -xf python-${{ env.PYTHON_VERSION }}-embed-amd64.zip -C python-${{ env.PYTHON_VERSION }}
          rm python-${{ env.PYTHON_VERSION }}-embed-amd64.zip

      - name: Install pip in Embedded Python
        run: |
          curl -O https://bootstrap.pypa.io/get-pip.py
          ./python-${{ env.PYTHON_VERSION }}/python.exe get-pip.py --no-warn-script-location
          rm get-pip.py

      - name: Enable site-packages in _pth file
        run: |
          $pthFile = Get-ChildItem "python-${{ env.PYTHON_VERSION }}\*.pth" | Select-Object -First 1
          (Get-Content $pthFile.FullName) | ForEach-Object { $_ -replace "#import site", "import site" } | Set-Content $pthFile.FullName
        shell: powershell

      - name: Install Required Packages into Embedded Python
        run: |
          ./python-${{ env.PYTHON_VERSION }}/python.exe -m pip install Cython --no-warn-script-location
          ./python-${{ env.PYTHON_VERSION }}/python.exe -m pip install numpy --no-warn-script-location
          ./python-${{ env.PYTHON_VERSION }}/python.exe -m pip install -r requirements-windows.txt --no-warn-script-location

      - name: Create Launcher BAT File
        run: |
          echo "start /min .\python-${{ env.PYTHON_VERSION }}\python.exe -m streamlit run ms2_main.py --server.headless=true" > ${{ env.APP_NAME }}.bat

      - name: Convert PNG icon to ICO
        run: |
          choco install imagemagick
          magick ms2_scanicon.png -resize 256x256 ms2_scanicon.ico

      - name: Create Executable Source Folder
        run: |
          mkdir SourceDir
          mkdir SourceDir/AppSubFolder
          mv python-${{ env.PYTHON_VERSION }} SourceDir/AppSubFolder/
          cp ms2_main.py SourceDir/AppSubFolder/
          cp requirements-windows.txt SourceDir/AppSubFolder/
          cp README.md SourceDir/AppSubFolder/
          cp LICENSE.rtf SourceDir/AppSubFolder/
          cp "${{ env.APP_NAME }}.bat" SourceDir/AppSubFolder/
          cp ms2_scanicon.ico SourceDir/

      - name: Install WiX Toolset
        run: |
          curl -LO https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311-binaries.zip
          mkdir wix
          tar -xf wix311-binaries.zip -C wix
          rm wix311-binaries.zip

      - name: Heat - Generate .wxs from folder
        run: |
          ./wix/heat.exe dir SourceDir/AppSubFolder -gg -sfrag -sreg -srd -template component -cg StreamlitExeFiles -dr AppSubFolder -var var.SourceDirSub -out streamlit_exe_files.wxs

      - name: Generate Main WiX Configuration (With Version Variable)
        shell: bash
        run: |
          cat <<EOF > streamlit_exe.wxs
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:fw="http://schemas.microsoft.com/wix/FirewallExtension">
            <Product Id="*" Name="${{ env.APP_NAME }}" Language="1033" Version="\$(var.ProductVersion)" Manufacturer="Your Org" UpgradeCode="b3e2c7a1-5e2a-4f6c-9e2d-1a2b3c4d5e6f">
              <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="x64"/>
              <Media Id="1" Cabinet="media.cab" EmbedCab="yes"/>
              
              <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER"/>
              
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFiles64Folder">
                  <Directory Id="INSTALLFOLDER" Name="${{ env.APP_NAME }}">
                     <Directory Id="AppSubFolder" Name="${{ env.APP_NAME }}" />
                  </Directory>
                </Directory>
                <Directory Id="DesktopFolder"/>
              </Directory>

              <Feature Id="MainFeature" Title="Main App" Level="1">
                <ComponentGroupRef Id="StreamlitExeFiles"/>
                <ComponentRef Id="DesktopShortcutComponent"/>
                <ComponentRef Id="FirewallExceptionComponent"/>
              </Feature>

              <Component Id="DesktopShortcutComponent" Guid="B1110000-0000-0000-0000-000000000001" Directory="DesktopFolder">
                <Shortcut Id="AppShortcut" Name="${{ env.APP_NAME }}" Description="Launch MS2 Analyzer" Target="[AppSubFolder]${{ env.APP_NAME }}.bat" WorkingDirectory="AppSubFolder" Icon="AppIcon"/>
                <RegistryValue Root="HKCU" Key="Software\\${{ env.APP_NAME }}" Name="Installed" Type="integer" Value="1" KeyPath="yes"/>
              </Component>

              <Component Id="FirewallExceptionComponent" Guid="C2220000-0000-0000-0000-000000000002" Directory="AppSubFolder" KeyPath="yes">
                <fw:FirewallException Id="PythonFirewallException"
                                      Name="${{ env.APP_NAME }} Python Server"
                                      Program="[AppSubFolder]python-${{ env.PYTHON_VERSION }}\python.exe"
                                      Scope="any"
                                      Profile="all"
                                      IgnoreFailure="yes"/>
              </Component>

              <Icon Id="AppIcon" SourceFile="SourceDir/ms2_scanicon.ico" />
              
              <UI>
                <UIRef Id="WixUI_InstallDir"/>
                <UIRef Id="WixUI_ErrorProgressText"/>
              </UI>
              <WixVariable Id="WixUILicenseRtf" Value="SourceDir/AppSubFolder/LICENSE.rtf"/>

            </Product>
          </Wix>
          EOF

      - name: Compile and Link (Candle & Light)
        run: |
          # Pass the dynamic version to Candle
          ./wix/candle.exe streamlit_exe.wxs -dProductVersion="${{ env.APP_VERSION }}" -ext WiXFirewallExtension -out streamlit_exe.wixobj
          ./wix/candle.exe streamlit_exe_files.wxs -dSourceDirSub="SourceDir/AppSubFolder" -out streamlit_exe_files.wixobj
          
          # Link and output with Version in filename
          ./wix/light.exe streamlit_exe.wixobj streamlit_exe_files.wixobj -ext WixUIExtension -ext WiXFirewallExtension -o "${{ env.APP_NAME }}_${{ env.APP_VERSION }}.msi" -cultures:en-us

      - name: Upload artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/ms2_App.exe
            ${{ env.APP_NAME }}_${{ env.APP_VERSION }}.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
