name: Build Executable for Windows on Release

on:
  release:
    types: ["created"]

permissions:
  contents: write

jobs:
  build-executable:
    runs-on: windows-latest

    env:
      PYTHON_VERSION: 3.9.0
      APP_NAME: MS2-Scan-Analyzer

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Python Embeddable Version
        run: |
          mkdir python-${{ env.PYTHON_VERSION }}
          curl -O https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip
          unzip python-${{ env.PYTHON_VERSION }}-embed-amd64.zip -d python-${{ env.PYTHON_VERSION }}
          rm python-${{ env.PYTHON_VERSION }}-embed-amd64.zip

      - name: Install pip
        run: |
          curl -O https://bootstrap.pypa.io/get-pip.py
          ./python-${{ env.PYTHON_VERSION }}/python get-pip.py --no-warn-script-location
          rm get-pip.py

      - name: Uncomment import site
        shell: bash
        run: |
          sed -i 's/#import site/import site/' python-${{ env.PYTHON_VERSION }}/python*._pth

      - name: Install Required Packages
        run: .\python-${{ env.PYTHON_VERSION }}\python -m pip install --force-reinstall -r requirements-windows.txt --no-warn-script-location

      - name: Create Streamlit Config
        shell: bash
        run: |
          mkdir .streamlit
          cat <<EOF > .streamlit/config.toml
          [server]
          address = "localhost"
          headless = true
          enableCORS = false
          enableXsrfProtection = false
          [browser]
          gatherUsageStats = false
          serverAddress = "localhost"
          EOF

      - name: Convert PNG icon to ICO
        run: magick ms2_scanicon.png -resize 256x256 ms2_scanicon.ico

      - name: Create Launcher BAT File
        shell: bash
        run: |
          cat <<'EOF' > ${{ env.APP_NAME }}.bat
          @echo off
          setlocal enabledelayedexpansion
          set "STREAMLIT_CONFIG_DIR=%TEMP%\.streamlit"
          set "MPLCONFIGDIR=%TEMP%\matplotlib"
          taskkill /F /IM python.exe /FI "WINDOWTITLE eq StreamlitBackend*" 2>nul >nul
          set PORT=8501
          set MAX_PORT=8600
          :FIND_PORT
          netstat -an | findstr ":!PORT! " | findstr "LISTENING" >nul
          if !errorlevel! equ 0 (
              set /a PORT+=1
              if !PORT! leq %MAX_PORT% goto FIND_PORT
              exit /b 1
          )
          start "StreamlitBackend" /B .\python-${{ env.PYTHON_VERSION }}\python -m streamlit run ms2_main.py --server.port !PORT! --server.address localhost --server.headless true --browser.gatherUsageStats false
          set /a RETRY_COUNT=0
          :CHECK_URL
          timeout /t 1 /nobreak >nul
          netstat -an | findstr ":!PORT! " | findstr "LISTENING" >nul
          if !errorlevel! neq 0 (
              set /a RETRY_COUNT+=1
              if !RETRY_COUNT! leq 15 goto CHECK_URL
          )
          start "" "http://localhost:!PORT!"
          pause >nul
          EOF

      - name: Create Executable Folder
        run: |
          mkdir streamlit_exe
          mv python-${{ env.PYTHON_VERSION }} streamlit_exe/
          mv .streamlit streamlit_exe/
          cp ms2_main.py streamlit_exe/
          if (Test-Path -Path "pages") { cp -r pages streamlit_exe/ }
          if (Test-Path -Path "src") { cp -r src streamlit_exe/ }
          if (Test-Path -Path "assets") { cp -r assets streamlit_exe/ }
          cp requirements-windows.txt streamlit_exe/
          cp README.md streamlit_exe/
          cp LICENSE.rtf streamlit_exe/
          cp "${{ env.APP_NAME }}.bat" streamlit_exe/

      - name: Install WiX Toolset
        run: |
          curl -LO https://github.com/wixtoolset/wix3/releases/download/wix3111rtm/wix311-binaries.zip
          unzip wix311-binaries.zip -d wix
          rm wix311-binaries.zip

      - name: Heat Build
        run: ./wix/heat.exe dir streamlit_exe -gg -sfrag -sreg -srd -template component -cg StreamlitExeFiles -dr AppSubFolder -out streamlit_exe_files.wxs

      - name: Generate VBScript
        shell: bash
        run: echo 'MsgBox "The ${{ env.APP_NAME }} application was installed successfully.", vbInformation, "Installation Complete"' > ShowSuccessMessage.vbs

      - name: Prepare SourceDir
        run: |
          mkdir SourceDir
          mv streamlit_exe/* SourceDir
          cp ShowSuccessMessage.vbs SourceDir
          echo "License Agreement" > SourceDir/app_license.rtf
          cp ms2_scanicon.ico SourceDir/app_icon.ico

      - name: Generate WiX XML
        shell: bash
        run: |
          cat <<EOF > streamlit_exe.wxs
          <?xml version="1.0"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*" Name="${{ env.APP_NAME }}" Language="1033" Version="1.0.0.0" Manufacturer="Functional Metabolomics Lab" UpgradeCode="b3e2c7a1-5e2a-4f6c-9e2d-1a2b3c4d5e6f">
              <Package InstallerVersion="300" Compressed="yes" InstallScope="perMachine" Platform="x64"/>
              <Media Id="1" Cabinet="media.cab" EmbedCab="yes"/>
              <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER"/>
              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFilesFolder">
                  <Directory Id="INSTALLFOLDER" Name="${{ env.APP_NAME }}">
                    <Directory Id="AppSubFolder" Name="${{ env.APP_NAME }}"/>
                  </Directory>
                </Directory>
                <Directory Id="DesktopFolder"/>
              </Directory>
              <Feature Id="MainFeature" Title="Main App" Level="1">
                <ComponentGroupRef Id="StreamlitExeFiles"/>
                <ComponentRef Id="DesktopShortcutComponent"/>
                <ComponentRef Id="InstallDirShortcutComponent"/>
              </Feature>
              <Component Id="DesktopShortcutComponent" Guid="B1110000-0000-0000-0000-000000000001" Directory="DesktopFolder">
                <Shortcut Id="DesktopAppShortcut" Name="${{ env.APP_NAME }}" Target="[AppSubFolder]${{ env.APP_NAME }}.bat" WorkingDirectory="AppSubFolder" Icon="AppIcon"/>
                <RegistryValue Root="HKCU" Key="Software\\FunctionalMetabolomicsLab\\${{ env.APP_NAME }}" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes"/>
              </Component>
              <Component Id="InstallDirShortcutComponent" Guid="664a0076-013e-4a60-9284-924ee1ec68be" Directory="AppSubFolder">
                <Shortcut Id="InstallDirShortcut" Name="${{ env.APP_NAME }}" Target="[AppSubFolder]${{ env.APP_NAME }}.bat" WorkingDirectory="AppSubFolder" Icon="AppIcon"/>
                <RegistryValue Root="HKCU" Key="Software\\FunctionalMetabolomicsLab\\${{ env.APP_NAME }}" Name="InstallFolderShortcut" Type="integer" Value="1" KeyPath="yes"/>
              </Component>
              <Icon Id="AppIcon" SourceFile="SourceDir/app_icon.ico" />
              <Binary Id="VBSMessage" SourceFile="SourceDir/ShowSuccessMessage.vbs"/>
              <CustomAction Id="ShowSuccess" BinaryKey="VBSMessage" VBScriptCall="" Execute="immediate" Return="check"/>
              <InstallExecuteSequence>
                <Custom Action="ShowSuccess" After="InstallFinalize">NOT Installed</Custom>
              </InstallExecuteSequence>
              <UI>
                <UIRef Id="WixUI_InstallDir"/>
                <UIRef Id="WixUI_ErrorProgressText"/>
              </UI>
              <WixVariable Id="WixUILicenseRtf" Value="SourceDir/app_license.rtf"/>
            </Product>
          </Wix>
          EOF

      - name: Candle
        run: |
          ./wix/candle.exe streamlit_exe.wxs -out streamlit_exe.wixobj
          ./wix/candle.exe streamlit_exe_files.wxs -out streamlit_exe_files.wixobj

      - name: Light
        run: ./wix/light.exe streamlit_exe.wixobj streamlit_exe_files.wixobj -ext WixUIExtension -o "${{ env.APP_NAME }}.msi" -cultures:en-us

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.APP_NAME }}.msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  